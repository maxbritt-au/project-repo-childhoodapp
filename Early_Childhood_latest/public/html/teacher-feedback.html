<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Feedback</title>

  <!-- Styles -->
  <link rel="stylesheet" href="../css/teacher-feedback.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* light styling for the list; keep or move to CSS file */
    .feedback-list.card { margin-top: 16px; padding: 16px; border-radius: 16px; background: rgba(255,255,255,.85); box-shadow: 0 4px 18px rgba(0,0,0,.1); }
    .feedback-item { padding: 12px 0; border-top: 1px solid #eee; }
    .feedback-item:first-child { border-top: 0; }
    .feedback-head { display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .feedback-title { font-weight: 600; }
    .feedback-date { font-size:.9rem; color:#666; }
    .feedback-body { margin-top:6px; white-space:pre-wrap; }
    .empty-hint { color:#666; font-style:italic; }
  </style>
</head>
<body class="light-mode">
  <div class="dashboard-container">
    <nav class="navbar">
      <div class="navbar-left">
        <a href="/html/teacher-dashboard.html" id="dashboardLogoLink" class="logo-link">
          <img src="../img/logo-2.png" alt="Logo" class="logo" />
        </a>
      </div>
      <div class="navbar-center">
        <ul class="nav-links">
          <li><a href="/html/teacher-dashboard.html" id="dashboardLink">Dashboard</a></li>
          <li><a href="/student-report" class="active">Reports</a></li>
          <li><a href="/children-dashboard">Child Dashboard</a></li>
        </ul>
      </div>
      <div class="navbar-right">
        <i class="fas fa-bell notification-icon"></i>
        <div class="theme-icons">
          <i class="fas fa-sun light-icon theme-toggle-btn"></i>
          <i class="fas fa-moon dark-icon theme-toggle-btn"></i>
        </div>
        <button id="open-logout-modal" class="logout-link">Logout</button>
      </div>
    </nav>

    <div class="main-content">
      <div class="feedback-grid">
        <!-- LEFT: Report preview -->
        <div class="report-viewer card">
          <div class="report-header">
            <h3 class="report-title" id="reportTitle">Loading report...</h3>
            <p class="student-info" id="studentInfo"></p>
          </div>
          <div class="report-body" id="reportBody">
            <p class="report-text">Fetching report details...</p>
          </div>
        </div>

        <!-- RIGHT: Feedback form + list -->
        <div class="feedback-form card">
          <h3 class="form-title">Submit Feedback</h3>
          <form id="feedbackForm">
            <input type="hidden" id="reportIdHidden" />
            <div class="form-group">
              <label for="feedback-title">Feedback Title</label>
              <input type="text" id="feedback-title" placeholder="e.g., Progress Report - Social Skills" required>
            </div>
            <div class="form-group">
              <label for="feedback-description">Feedback Details</label>
              <textarea id="feedback-description" placeholder="Write your feedback here..." required></textarea>
            </div>
            <div class="form-actions">
              <button type="submit" class="submit-btn">Submit</button>
              <button type="button" class="export-btn" onclick="exportPDF()">Export to PDF</button>
            </div>
            <p id="feedbackMsg" class="muted" style="margin-top:10px;"></p>
          </form>

          <!-- Existing feedback list -->
          <div id="feedbackList" class="feedback-list card">
            Loading feedbackâ€¦
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Logout modal -->
  <div id="logout-modal" class="modal">
    <div class="modal-content">
      <h3>Are you sure you want to log out?</h3>
      <div class="modal-actions">
        <button id="cancel-logout-btn" class="modal-btn secondary">Cancel</button>
        <button id="confirm-logout-btn" class="modal-btn primary">Log Out</button>
      </div>
    </div>
  </div>

  <!-- Scripts (defer so DOM is ready) -->
  <script defer src="../js/router.js"></script>
  <script defer src="../js/theme-toggle.js"></script>
  <script defer src="../js/teacher-feedback.js"></script>
  <!-- ðŸ”‘ Include navbar.js so it can set Dashboard link based on /api/me -->
  <script defer src="../js/navbar.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const FEEDBACK_ENDPOINT = '/api/feedbacks';

    const esc = (s) => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const toDate = (x) => x ? new Date(x).toLocaleString() : '';

    async function loadReport() {
      const params = new URLSearchParams(window.location.search);
      const reportId = params.get('reportId') || params.get('id');
      document.getElementById('reportIdHidden').value = reportId || '';

      if (!reportId) {
        document.getElementById("reportBody").innerHTML = "<p>No report ID provided.</p>";
        document.getElementById("feedbackList").textContent = 'No report ID provided.';
        return;
      }

      try {
        const res = await fetch(`/api/reports/${encodeURIComponent(reportId)}`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to fetch report');
        const report = await res.json();

        document.getElementById('reportTitle').textContent =
          report.template_title || (String(report.template_id) === '1' ? 'Observation Report'
                                  : String(report.template_id) === '2' ? 'Anecdotal Record'
                                  : 'Student Report');

        const studentName = report.student_name || report.child_name || 'Unknown';
        const sid = report.student_id || report.child_id || 'N/A';
        const dateStr = report.submitted_at ? new Date(report.submitted_at).toLocaleDateString()
                                            : (report.content?.date || '');
        document.getElementById('studentInfo').textContent =
          `${studentName} (ID: ${sid})${dateStr ? ' â€” ' + dateStr : ''}`;

        let content = {};
        try { content = typeof report.content === 'string' ? JSON.parse(report.content) : (report.content || {}); }
        catch { content = report.content || {}; }

        const body = document.getElementById('reportBody');
        body.innerHTML = '';
        const blocks = [];

        if (String(report.template_id) === '1') {
          if (content.observation) blocks.push(['Observation', content.observation]);
          if (content.activity)    blocks.push(['Activity / Context', content.activity]);
          if (content.outcomes)    blocks.push(['Learning Outcomes', content.outcomes]);
        } else if (String(report.template_id) === '2') {
          if (content.observation) blocks.push(['Narrative Observation', content.observation]);
          if (content.domains)     blocks.push(['Domains', content.domains]);
          if (content.eylf)        blocks.push(['EYLF Links', content.eylf]);
          if (content.theory)      blocks.push(['Theory', content.theory]);
          if (content.planning_ideas) blocks.push(['Future Planning', content.planning_ideas]);
        } else {
          if (content.summary)  blocks.push(['Summary', content.summary]);
          if (content.domains)  blocks.push(['Domains', content.domains]);
          if (content.outcomes) blocks.push(['Outcomes', content.outcomes]);
          if (content.period)   blocks.push(['Assessment Period', content.period]);
        }

        body.innerHTML = blocks.length
          ? blocks.map(([label, value]) =>
              `<section class="report-chunk">
                 <h4 class="report-sub-title">${esc(label)}</h4>
                 <p class="report-text">${esc(value)}</p>
               </section>`
            ).join('')
          : '<p class="report-text">No detailed content available.</p>';

        // load feedback list for this report
        await loadFeedbackList(reportId);

      } catch (err) {
        console.error(err);
        document.getElementById('reportBody').innerHTML = `<p style="color:#b00020;">Error: ${esc(err.message)}</p>`;
        document.getElementById('feedbackList').textContent = 'Failed to load feedback.';
      }
    }

    async function loadFeedbackList(reportId) {
      const box = document.getElementById('feedbackList');
      box.textContent = 'Loading feedbackâ€¦';
      try {
        const res = await fetch(`${FEEDBACK_ENDPOINT}?reportId=${encodeURIComponent(reportId)}`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to fetch feedback');
        const rows = await res.json();

        if (!rows.length) {
          box.innerHTML = '<p class="empty-hint">No feedback yet.</p>';
          return;
        }

        box.innerHTML = rows.map(r => `
          <div class="feedback-item">
            <div class="feedback-head">
              <span class="feedback-title">${esc(r.title || 'Feedback')}</span>
              <span class="feedback-date">${esc(toDate(r.created_at))}</span>
            </div>
            <div class="feedback-body">${esc(r.comment || '')}</div>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
        box.textContent = 'Failed to load feedback.';
      }
    }

    // Try to get the teacher id from localStorage; if missing, fetch /api/me
async function getTeacherId() {
  // 1) local cache
  try {
    const u = JSON.parse(localStorage.getItem('user') || '{}');
    const id = u?.userId ?? u?.id ?? u?.teacher_id;
    if (id) return Number(id);
  } catch {}

  // 2) session-backed API
  try {
    const res = await fetch('/api/me', { credentials: 'include' });
    if (res.ok) {
      const me = await res.json();
      const id = me?.userId ?? me?.id ?? me?.teacher_id;
      if (id) {
        try { localStorage.setItem('user', JSON.stringify(me)); } catch {}
        return Number(id);
      }
    }
  } catch {}

  return null;
}

// Submit feedback tied to reportId and refresh list
async function handleFeedbackSubmit(e) {
  e.preventDefault();
  const msg = document.getElementById('feedbackMsg');
  msg.textContent = '';

  const reportId = document.getElementById('reportIdHidden').value;
  const title = document.getElementById('feedback-title').value.trim();
  const description = document.getElementById('feedback-description').value.trim();

  if (!reportId) { msg.textContent = 'Missing reportId.'; msg.style.color = '#b00020'; return; }
  if (!title || !description) { msg.textContent = 'Please complete title and details.'; msg.style.color = '#b00020'; return; }

  // ðŸ”‘ Make sure we have a teacher id (from session or cache)
  const teacherId = await getTeacherId();
  if (!teacherId) {
    msg.textContent = 'Could not determine your teacher account. Please log in again.';
    msg.style.color = '#b00020';
    return;
  }

  try {
    const res = await fetch(FEEDBACK_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        report_id: Number(reportId),
        title,
        description,          // server maps description -> comment
        teacher_id: teacherId // ensured non-null
      })
    });

    if (!res.ok) throw new Error(await res.text().catch(() => 'Failed to submit feedback'));
    msg.textContent = 'Feedback submitted successfully.';
    msg.style.color = '#2e7d32';
    document.getElementById('feedbackForm').reset();

    // refresh list
    loadFeedbackList(reportId);
  } catch (err) {
    console.error(err);
    msg.textContent = err.message || 'Submission failed.';
    msg.style.color = '#b00020';
  }
}

    document.addEventListener('DOMContentLoaded', () => {
      loadReport();
      document.getElementById('feedbackForm')?.addEventListener('submit', handleFeedbackSubmit);
    });

    // Placeholder for PDF export
    function exportPDF() { alert('Export to PDF coming soon.'); }
  </script>
</body>
</html>
