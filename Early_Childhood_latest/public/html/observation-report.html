<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Observation Report</title>

  <!-- Use the same design system as Summative/Anecdotal -->
  <link rel="stylesheet" href="../css/observation-report.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <script defer src="/js/router.js"></script>
  <script defer src="/js/theme-toggle.js"></script>
  <script defer src="/js/report-helper.js"></script>
  <script defer src="/js/logout.js"></script>
</head>
<body class="light-mode">
  <div class="dashboard-container">
    <nav class="navbar">
      <div class="navbar-left">
        <a href="#" id="dashboardLogoLink" class="logo-link">
          <img src="../img/logo-2.png" alt="Logo" class="logo" />
        </a>
      </div>
      <div class="navbar-center">
        <ul class="nav-links">
          <li><a href="/student-dashboard" id="dashboardLink">Dashboard</a></li>
          <li><a href="/student-report" class="active">Reports</a></li>
          <li><a href="/children-dashboard">Child Dashboard</a></li>
        </ul>
      </div>
      <div class="navbar-right">
        <i class="fas fa-sun theme-icon sun-icon"></i>
        <label class="theme-switch" for="theme-toggle">
          <input type="checkbox" id="theme-toggle" />
          <span class="slider"></span>
        </label>
        <i class="fas fa-moon theme-icon moon-icon"></i>
        <button id="open-logout-modal" class="logout-link">Logout</button>
      </div>
    </nav>

    <main class="main-content">
      <div class="form-layout">
        <section class="form-panel card">
          <h1 class="page-title">
            <i class="fas fa-eye" style="margin-right:10px;"></i>
            Observation Report
          </h1>
          <p class="intro-text">
            Record key observations from class or play activities, focusing on developmental progress and learning outcomes.
          </p>

          <form id="observationForm" class="report-form">
            <!-- Hidden fallback for helper.resolveChildId() -->
            <input type="hidden" id="childId" name="childId" />

            <!-- SECTION 1: Child Details -->
            <fieldset class="form-fieldset child-details">
              <legend>Child Details</legend>

              <div class="form-row">
                <div class="form-group">
                  <label for="childSelect">Child</label>
                  <select id="childSelect" name="child_id" required>
                    <option value="">— Select a child —</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="age">Age</label>
                  <input id="age" name="age" type="text" readonly />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="date">Date</label>
                  <input id="date" name="date" type="date" required />
                </div>

                <div class="form-group">
                  <label for="activity">Activity / Context</label>
                  <input id="activity" name="activity" type="text" placeholder="" />
                </div>
              </div>
            </fieldset>

            <!-- SECTION 2: Observation -->
            <fieldset class="form-fieldset summary-section">
              <legend>Observation</legend>
              <div class="form-group">
                <label for="observation">Observation Notes</label>
                <textarea id="observation" name="observation" rows="6"
                  placeholder="Write a clear, objective narrative of what you observed…"></textarea>
              </div>
            </fieldset>

            <!-- SECTION 3: Learning Outcomes -->
            <fieldset class="form-fieldset domains-section">
              <legend>Learning Outcomes</legend>
              <div class="form-group">
                <label for="outcomes">Outcomes / Links</label>
                <textarea id="outcomes" name="outcomes" rows="6"
                  placeholder="Link to EYLF outcomes or centre goals…"></textarea>
              </div>
            </fieldset>

            <div class="form-actions">
              <button type="reset" class="modal-btn secondary">Reset</button>
              <button class="modal-btn primary" type="submit">Save Report</button>
            </div>
          </form>
        </section>
      </div>
    </main>
  </div>

  <!-- Logout modal -->
  <div id="logout-modal" class="modal">
    <div class="modal-content">
      <h3>Are you sure you want to log out?</h3>
      <div class="modal-actions">
        <button id="cancel-logout-btn" class="modal-btn secondary">Cancel</button>
        <button id="confirm-logout-btn" class="modal-btn primary">Log Out</button>
      </div>
    </div>
  </div>

  <script>
    // Load children & wire age + hidden childId
    async function loadChildren() {
      try {
        const res = await fetch('/api/children', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load children');

        const children = await res.json();
        const select = document.getElementById('childSelect');
        const hiddenChild = document.getElementById('childId');

        // Respect ?childId= in URL
        const urlParams = new URLSearchParams(window.location.search);
        const childIdFromUrl = urlParams.get('childId');

        children.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.child_id;
          opt.textContent = `${c.first_name} ${c.last_name}`;
          select.appendChild(opt);
        });

        if (childIdFromUrl) {
          select.value = childIdFromUrl;
          hiddenChild.value = childIdFromUrl;
        }

        function updateDerived() {
          hiddenChild.value = select.value || '';
          const chosen = children.find(c => String(c.child_id) === String(select.value));
          if (chosen?.dob) {
            const dob = new Date(chosen.dob);
            const diff = Date.now() - dob.getTime();
            const age = Math.floor(diff / (1000 * 60 * 60 * 24 * 365.25));
            document.getElementById('age').value = age;
          } else {
            document.getElementById('age').value = '';
          }
        }

        select.addEventListener('change', updateDerived);
        updateDerived();
      } catch (err) {
        console.error(err);
      }
    }
    loadChildren();

    // Default today's date
    (function setDefaultDate() {
      const dateEl = document.getElementById('date');
      if (dateEl && !dateEl.value) {
        const today = new Date();
        dateEl.value = today.toISOString().slice(0,10);
      }
    })();

    // Hook up your helper AFTER it's loaded
    window.addEventListener('DOMContentLoaded', () => {
      attachReportForm('#observationForm', {
        templateId: 1,
        getContent: () => {
          const select = document.getElementById('childSelect');
          const selectedOption = select.options[select.selectedIndex];
          const payload = {
            child_name: selectedOption ? selectedOption.textContent : '',
            age: document.getElementById('age').value,
            date: document.getElementById('date').value || new Date().toISOString().slice(0,10),
            activity: document.getElementById('activity').value.trim(),
            observation: document.getElementById('observation').value.trim(),
            outcomes: document.getElementById('outcomes').value.trim()
          };
          return JSON.stringify(payload);
        }
      });
    });

    // Draft autosave
    const form = document.getElementById("observationForm");
    const storageKey = "observationFormDraft";

    window.addEventListener("DOMContentLoaded", () => {
      const saved = localStorage.getItem(storageKey);
      if (saved) {
        const data = JSON.parse(saved);
        Object.keys(data).forEach(key => {
          const field = form.elements[key];
          if (field) field.value = data[key];
        });
      }
    });

    form.addEventListener("input", () => {
      const formData = {};
      Array.from(form.elements).forEach(el => {
        if (el.name) formData[el.name] = el.value;
      });
      localStorage.setItem(storageKey, JSON.stringify(formData));
    });

    form.addEventListener("submit", () => {
      localStorage.removeItem(storageKey);
    });
  </script>
</body>
</html>
