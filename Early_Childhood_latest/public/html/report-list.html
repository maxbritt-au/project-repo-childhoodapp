<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reports</title>
  <link rel="stylesheet" href="../css/report-list.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script defer src="../js/logout.js"></script>
  <script defer src="../js/navbar.js"></script>
  <style>
    .card-table{background:#fff;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:16px;overflow:hidden}
    .table-toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:6px 4px 12px 4px;flex-wrap:wrap}
    .table-toolbar .search{flex:1 1 260px;display:flex;gap:8px;align-items:center}
    .table-toolbar input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e4e4e4;background:#fff;font-size:.95rem}
    .reports-table{width:100%;border-collapse:collapse}
    .reports-table th,.reports-table td{padding:12px 10px;border-bottom:1px solid #eee;text-align:left;font-size:.95rem}
    .reports-table th{font-weight:700;color:#333;background:#fafafa}
    .reports-table tr:hover{background:#fafcff}
    .pill-link{display:inline-block;background:#eef3ff;color:#0b5fff;padding:6px 10px;border-radius:999px;text-decoration:none;font-weight:600;font-size:.9rem;white-space:nowrap}
    .btn{border:1px solid #e0e0e0;background:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:.9rem}
    .btn:hover{background:#fafafa}
    .btn.danger{border-color:#ffd4d4;background:#ffecec;color:#b00020}
    .btn.danger:hover{background:#ffdede}
    .muted{color:#777}
    .actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;padding-top:12px}
    .pagination button{border:1px solid #e0e0e0;background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    .pagination button:disabled{opacity:.5;cursor:not-allowed}
    @media (max-width: 840px){
      .reports-table th:nth-child(4),
      .reports-table td:nth-child(4){display:none} /* hide Date on small screens */
    }
  </style>
</head>
<body class="light-mode">
  <div class="dashboard-container">
    <nav class="navbar">
      <div class="navbar-left">
        <a href="/teacher-dashboard" class="logo-link">
          <img src="../img/logo-2.png" alt="Logo" class="logo" />
        </a>
      </div>
      <div class="navbar-center">
        <ul class="nav-links">
          <li><a href="/student-dashboard" id="dashboardLink">Dashboard</a></li>
          <li><a href="/student-report" class="active">Reports</a></li>
          <li><a href="/children-dashboard" >Child Dashboard</a></li>
        </ul>
      </div>
      <div class="navbar-right">
        <i class="fas fa-bell notification-icon"></i>
        <button id="open-logout-modal" class="logout-link">Logout</button>
      </div>
    </nav>

    <main class="main-content wrap">
      <h1 class="page-title">Reports</h1>

      <div class="card card-table" id="reportsCard">
        <div class="table-toolbar">
          <div class="search">
            <i class="fa-solid fa-magnifying-glass muted"></i>
            <input id="searchInput" type="text" placeholder="Search by report type, student, or child..." />
          </div>
          <div class="muted" id="countLabel">Loading...</div>
        </div>

        <div id="reportsList">
          <p class="muted" style="padding: 8px 4px;">Loading reports...</p>
        </div>

        <div class="pagination">
          <button id="prevBtn" disabled>&laquo; Previous</button>
          <span id="pageInfo" class="muted">Page 1</span>
          <button id="nextBtn" disabled>Next &raquo;</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    (function() {
      const listEl = document.getElementById('reportsList');
      const searchEl = document.getElementById('searchInput');
      const countEl = document.getElementById('countLabel');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageInfo = document.getElementById('pageInfo');

      // Client state
      let all = [];
      let filtered = [];
      let page = 1;
      const pageSize = 50;

      // Server paging
      let serverOffset = 0;
      let serverHasMore = false;

      async function loadPage(offset = 0) {
        listEl.innerHTML = '<p class="muted" style="padding:8px 4px;">Loading reports...</p>';
        try {
          // Prefer /all; fallback to /recent
          const urlAll = `/api/reports/all?limit=${pageSize}&offset=${offset}`;
          let res = await fetch(urlAll, { credentials: 'include' });
          if (!res.ok) {
            const urlRecent = `/api/reports/recent?limit=500`;
            res = await fetch(urlRecent, { credentials: 'include' });
            if (!res.ok) throw new Error('Failed to fetch reports');
            const recent = await res.json();
            all = recent.map(r => ({
              id: r.id,
              report_type: r.report_type || r.template_title || 'Report',
              student_name: r.student_name || '',
              child_name: r.child_name || [r.child_first_name, r.child_last_name].filter(Boolean).join(' '),
              created_at: r.created_at || r.submitted_at
            }));
            serverHasMore = false;
            serverOffset = 0;
            page = 1;
            filtered = all;
            render();
            return;
          }

          const rows = await res.json();
          all = rows.map(r => ({
            id: r.id,
            report_type: r.report_type || r.template_title || 'Report',
            student_name: r.student_name || '',
            child_name: r.child_name || [r.first_name, r.last_name].filter(Boolean).join(' '),
            created_at: r.created_at || r.submitted_at
          }));

          serverHasMore = all.length === pageSize;
          serverOffset = offset;
          page = Math.floor(offset / pageSize) + 1;
          filtered = all;
          render();
        } catch (err) {
          console.error(err);
          listEl.innerHTML = '<p class="muted" style="padding:8px 4px;color:#c00;">Could not load reports.</p>';
          countEl.textContent = '';
        }
      }

      function render() {
        const q = (searchEl.value || '').toLowerCase();
        const items = !q
          ? filtered
          : filtered.filter(r =>
              (r.report_type || '').toLowerCase().includes(q) ||
              (r.student_name || '').toLowerCase().includes(q) ||
              (r.child_name || '').toLowerCase().includes(q)
            );

        countEl.textContent = `${items.length} report${items.length === 1 ? '' : 's'}${serverHasMore ? ' (page ' + page + ')' : ''}`;

        if (!items.length) {
          listEl.innerHTML = '<p class="muted" style="padding:8px 4px;">No reports found.</p>';
          pageInfo.textContent = `Page ${page}`;
          prevBtn.disabled = serverOffset <= 0;
          nextBtn.disabled = !serverHasMore;
          return;
        }

        const rows = items.map(r => {
          const viewUrl = `/html/report-view.html?reportId=${encodeURIComponent(r.id)}`;
          const dateStr = r.created_at ? new Date(r.created_at).toLocaleString() : '';
          return `
            <tr>
              <td><a class="pill-link" href="${viewUrl}" title="View report">${escapeHtml(r.report_type)}</a></td>
              <td>${escapeHtml(r.student_name || '')}</td>
              <td>${escapeHtml(r.child_name || '')}</td>
              <td class="muted">${escapeHtml(dateStr)}</td>
              <td class="actions">
                <button class="btn danger" data-id="${escapeHtml(String(r.id))}" aria-label="Delete report">Delete</button>
              </td>
            </tr>
          `;
        }).join('');

        listEl.innerHTML = `
          <table class="reports-table" role="table" aria-label="Reports">
            <thead>
              <tr>
                <th>Report Type</th>
                <th>Student</th>
                <th>Child</th>
                <th>Date</th>
                <th style="width:110px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        `;

        // Wire delete buttons
        listEl.querySelectorAll('button[data-id]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            if (!confirm('Delete this report? This action cannot be undone.')) return;

            const prev = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Deletingâ€¦';
            try {
              await apiDelete(id);
              // Remove from local arrays and re-render
              all = all.filter(r => String(r.id) !== String(id));
              filtered = filtered.filter(r => String(r.id) !== String(id));
              render();
              // If we emptied this server page and there are more, reload next
              if (!all.length && serverHasMore) {
                await loadPage(serverOffset + pageSize);
              }
            } catch (e) {
              alert(e.message || 'Failed to delete report.');
              btn.disabled = false;
              btn.textContent = prev;
            }
          });
        });

        pageInfo.textContent = `Page ${page}`;
        prevBtn.disabled = serverOffset <= 0;
        nextBtn.disabled = !serverHasMore;
      }

      function escapeHtml(str='') {
        return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      }

      async function apiDelete(id) {
        const res = await fetch(`/api/reports/${encodeURIComponent(id)}`, {
          method: 'DELETE',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });
        if (!res.ok) {
          let msg = '';
          try { msg = await res.text(); } catch {}
          throw new Error(msg || 'Delete failed');
        }
        return true;
      }

      searchEl.addEventListener('input', render);
      prevBtn.addEventListener('click', () => { if (serverOffset > 0) loadPage(serverOffset - pageSize); });
      nextBtn.addEventListener('click', () => { if (serverHasMore) loadPage(serverOffset + pageSize); });

      loadPage(0);
    })();
  </script>
</body>
</html>
